{% extends 'base.html' %}

{% block title %}Chat Documents{% endblock %}

{% block extra_css %}
<style>
    :root {
        --sidebar-width: 260px;
        --header-height: 70px;
        --primary-color: #4f46e5;
        --primary-dark: #3730a3;
        --secondary-color: #10b981;
        --accent-color: #8b5cf6;
        --dark-bg: #111827;
        --dark-card: #1f2937;
        --dark-text: #f9fafb;
        --dark-border: #374151;
        --dark-hover: #2d3748;
        --light-bg: #f8fafc;
        --light-card: #ffffff;
        --light-border: #e5e7eb;
        --light-hover: #f3f4f6;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --rounded-sm: 0.375rem;
        --rounded-md: 0.5rem;
        --rounded-lg: 0.75rem;
        --rounded-full: 9999px;
        --transition: all 0.3s ease;
    }
    
    body {
        background-color: var(--light-bg);
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        transition: var(--transition);
    }
    
    body.dark-mode {
        background-color: var(--dark-bg);
        color: var(--dark-text);
    }
    
    .dashboard-container {
        display: flex;
        min-height: 100vh;
        position: relative;
    }
    
    .sidebar {
        width: var(--sidebar-width);
        background-color: var(--light-card);
        border-right: 1px solid var(--light-border);
        position: fixed;
        height: 100vh;
        z-index: 100;
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-direction: column;
    }
    
    body.dark-mode .sidebar {
        background-color: var(--dark-card);
        border-color: var(--dark-border);
    }
    
    .logo-container {
        padding: 1.5rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--light-border);
        margin-bottom: 0;
    }
    
    body.dark-mode .logo-container {
        border-color: var(--dark-border);
    }
    
    .logo-text {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        color: var(--primary-color);
        letter-spacing: 2px;
        font-family: 'Poppins', 'Inter', sans-serif;
    }
    
    body.dark-mode .logo-text {
        color: var(--primary-color);
    }
    
    .sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid var(--light-border);
    }
    
    body.dark-mode .sidebar-header {
        border-color: var(--dark-border);
    }
    
    .user-profile {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: var(--rounded-full);
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .user-info h3 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
    }
    
    .user-info p {
        font-size: 0.75rem;
        color: #6b7280;
        margin: 0;
    }
    
    body.dark-mode .user-info p {
        color: #9ca3af;
    }
    
    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 1rem 0;
    }
    
    .sidebar-menu {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .sidebar-menu li {
        margin-bottom: 0.25rem;
    }
    
    .sidebar-menu li a {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.25rem;
        color: #4b5563;
        text-decoration: none;
        transition: var(--transition);
        border-left: 3px solid transparent;
    }
    
    body.dark-mode .sidebar-menu li a {
        color: #d1d5db;
    }
    
    .sidebar-menu li a:hover {
        background-color: var(--light-hover);
        color: var(--primary-color);
    }
    
    body.dark-mode .sidebar-menu li a:hover {
        background-color: var(--dark-hover);
        color: var(--primary-color);
    }
    
    .sidebar-menu li.active a {
        background-color: rgba(79, 70, 229, 0.1);
        color: var(--primary-color);
        border-left: 3px solid var(--primary-color);
        font-weight: 500;
    }
    
    body.dark-mode .sidebar-menu li.active a {
        background-color: rgba(79, 70, 229, 0.2);
    }
    
    .sidebar-footer {
        padding: 1rem;
        border-top: 1px solid var(--light-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    body.dark-mode .sidebar-footer {
        border-color: var(--dark-border);
    }
    
    .dark-mode-toggle, .sidebar-toggle {
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        font-size: 0.875rem;
        padding: 0.5rem;
        border-radius: var(--rounded-md);
        transition: var(--transition);
    }
    
    body.dark-mode .dark-mode-toggle, 
    body.dark-mode .sidebar-toggle {
        color: #d1d5db;
    }
    
    .dark-mode-toggle:hover, 
    .sidebar-toggle:hover {
        background-color: var(--light-hover);
        color: var(--primary-color);
    }
    
    body.dark-mode .dark-mode-toggle:hover, 
    body.dark-mode .sidebar-toggle:hover {
        background-color: var(--dark-hover);
    }
    
    .main-content {
        flex: 1;
        margin-left: var(--sidebar-width);
        transition: var(--transition);
        padding: 1rem;
    }
    
    .chat-container {
        display: flex;
        height: calc(100vh - var(--header-height));
        background-color: var(--light-bg);
        border-radius: var(--rounded-lg);
        overflow: hidden;
        box-shadow: var(--shadow-md);
    }
    
    body.dark-mode .chat-container {
        background-color: var(--dark-bg);
    }
    
    .chat-sidebar {
        width: 320px;
        border-right: 1px solid var(--light-border);
        display: flex;
        flex-direction: column;
        background-color: var(--light-card);
        box-shadow: var(--shadow-sm);
    }
    
    body.dark-mode .chat-sidebar {
        background-color: var(--dark-card);
        border-color: var(--dark-border);
    }
    
    .model-selector {
        padding: 1.25rem;
        border-bottom: 1px solid var(--light-border);
        background-color: var(--light-card);
    }
    
    body.dark-mode .model-selector {
        border-color: var(--dark-border);
        background-color: var(--dark-card);
    }
    
    .model-selector label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #4b5563;
    }
    
    body.dark-mode .model-selector label {
        color: #d1d5db;
    }
    
    .model-selector select {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border-radius: var(--rounded-md);
        border: 1px solid var(--light-border);
        background-color: var(--light-card);
        font-size: 0.875rem;
        transition: var(--transition);
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
    }
    
    body.dark-mode .model-selector select {
        background-color: var(--dark-hover);
        border-color: var(--dark-border);
        color: var(--dark-text);
    }
    
    .model-selector select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
    }
    
    .document-section {
        padding: 1.25rem;
        flex: 1;
        overflow-y: auto;
        background-color: var(--light-card);
    }
    
    body.dark-mode .document-section {
        background-color: var(--dark-card);
    }
    
    .document-section h3 {
        font-size: 0.875rem;
        text-transform: uppercase;
        color: #6b7280;
        margin-bottom: 1rem;
        font-weight: 600;
        letter-spacing: 0.05em;
    }
    
    body.dark-mode .document-section h3 {
        color: #9ca3af;
    }
    
    .document-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.625rem;
    }
    
    .document-item {
        padding: 0.75rem;
        border-radius: var(--rounded-md);
        background-color: var(--light-card);
        box-shadow: var(--shadow-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: var(--transition);
        border: 1px solid var(--light-border);
    }
    
    body.dark-mode .document-item {
        background-color: var(--dark-hover);
        border-color: var(--dark-border);
    }
    
    .document-item:hover {
        background-color: var(--light-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    body.dark-mode .document-item:hover {
        background-color: #374151;
        border-color: var(--dark-border);
    }
    
    .document-item.selected {
        background-color: rgba(79, 70, 229, 0.1);
        border-left: 3px solid var(--primary-color);
    }
    
    body.dark-mode .document-item.selected {
        background-color: rgba(79, 70, 229, 0.2);
        border-left-color: var(--primary-color);
    }
    
    .document-icon {
        margin-right: 0.75rem;
        color: #6b7280;
        font-size: 1.25rem;
        width: 1.5rem;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .document-name {
        font-size: 0.875rem;
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }
    
    .delete-document {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: var(--rounded-sm);
        transition: var(--transition);
        color: #9ca3af;
        opacity: 0.6;
    }
    
    .document-item:hover .delete-document {
        opacity: 1;
    }
    
    .delete-document:hover {
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    body.dark-mode .delete-document:hover {
        background-color: rgba(239, 68, 68, 0.2);
        color: #f87171;
    }
    
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: var(--light-bg);
        border-radius: var(--rounded-md);
        margin: 1rem;
        box-shadow: var(--shadow-md);
    }
    
    body.dark-mode .chat-main {
        background-color: var(--dark-bg);
    }
    
    .chat-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--light-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: var(--light-card);
    }
    
    body.dark-mode .chat-header {
        border-color: var(--dark-border);
        background-color: var(--dark-card);
    }
    
    .chat-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
    }
    
    .chat-title i {
        margin-right: 0.5rem;
        color: var(--primary-color);
    }
    
    body.dark-mode .chat-title {
        color: #e0f2fe;
    }
    
    body.dark-mode .chat-title i {
        color: var(--primary-color);
    }
    
    .chat-messages {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background-color: var(--light-bg);
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }
    
    body.dark-mode .chat-messages {
        background-color: var(--dark-bg);
    }
    
    .message {
        max-width: 85%;
        position: relative;
        animation: fadeIn 0.3s ease;
        border-radius: var(--rounded-lg);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message p {
        margin: 0;
        line-height: 1.6;
    }
    
    .message p + p {
        margin-top: 0.75rem;
    }
    
    .message-user {
        margin-left: auto;
        background-color: var(--primary-color);
        color: white;
        border-radius: var(--rounded-lg) var(--rounded-lg) 0 var(--rounded-lg);
        padding: 1rem 1.25rem;
        align-self: flex-end;
        box-shadow: var(--shadow-md);
    }
    
    .message-bot {
        background-color: var(--light-card);
        border-radius: var(--rounded-lg) var(--rounded-lg) var(--rounded-lg) 0;
        padding: 1rem 1.25rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--light-border);
        align-self: flex-start;
    }
    
    body.dark-mode .message-bot {
        background-color: var(--dark-card);
        color: var(--dark-text);
        border-color: var(--dark-border);
    }
    
    .message-bot.error {
        background-color: #fee2e2;
        border-color: #fecaca;
        color: #b91c1c;
    }
    
    body.dark-mode .message-bot.error {
        background-color: #7f1d1d;
        border-color: #b91c1c;
        color: #fecaca;
    }
    
    .typing-indicator {
        padding: 0.75rem 1rem;
        align-self: flex-start;
        display: flex;
        align-items: center;
    }
    
    .typing-dots {
        display: flex;
        align-items: center;
        height: 1.25rem;
    }
    
    .typing-dots span {
        height: 0.5rem;
        width: 0.5rem;
        margin: 0 0.125rem;
        background-color: var(--primary-color);
        border-radius: 50%;
        display: inline-block;
        opacity: 0.6;
    }
    
    .typing-dots span:nth-child(1) {
        animation: bounce 1.2s infinite 0.2s;
    }
    
    .typing-dots span:nth-child(2) {
        animation: bounce 1.2s infinite 0.4s;
    }
    
    .typing-dots span:nth-child(3) {
        animation: bounce 1.2s infinite 0.6s;
    }
    
    @keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-4px);
        }
    }
    
    .chat-input {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--light-border);
        background-color: var(--light-card);
    }
    
    body.dark-mode .chat-input {
        background-color: var(--dark-card);
        border-color: var(--dark-border);
    }
    
    .chat-input form {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .chat-input input {
        flex: 1;
        padding: 0.875rem 1.25rem;
        border: 1px solid var(--light-border);
        border-radius: var(--rounded-full);
        font-size: 0.95rem;
        outline: none;
        transition: var(--transition);
        background-color: var(--light-bg);
    }
    
    .chat-input input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
    }
    
    body.dark-mode .chat-input input {
        background-color: var(--dark-hover);
        border-color: var(--dark-border);
        color: var(--dark-text);
    }
    
    body.dark-mode .chat-input input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
    }
    
    .chat-input button {
        width: 2.75rem;
        height: 2.75rem;
        border-radius: var(--rounded-full);
        background-color: var(--primary-color);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
    }
    
    .chat-input button:hover {
        background-color: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .chat-input button:active {
        transform: scale(0.95);
    }
    
    #clear-chat {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem 0.75rem;
        border-radius: var(--rounded-md);
        font-size: 0.875rem;
        transition: var(--transition);
        display: flex;
        align-items: center;
        color: #6b7280;
    }
    
    #clear-chat i {
        margin-right: 0.375rem;
    }
    
    #clear-chat:hover {
        background-color: var(--light-hover);
        color: #4b5563;
    }
    
    body.dark-mode #clear-chat {
        color: #9ca3af;
    }
    
    body.dark-mode #clear-chat:hover {
        background-color: var(--dark-hover);
        color: #d1d5db;
    }
    
    .flex {
        display: flex;
    }
    
    .justify-between {
        justify-content: space-between;
    }
    
    .items-center {
        align-items: center;
    }
    
    .mb-4 {
        margin-bottom: 1rem;
    }
    
    .cursor-pointer {
        cursor: pointer;
    }
    
    .hidden {
        display: none;
    }
    
    .text-xs {
        font-size: 0.75rem;
    }
    
    .mt-1 {
        margin-top: 0.25rem;
    }
    
    .text-gray-500 {
        color: #6b7280;
    }
    
    .dark\:text-gray-400 {
        color: #9ca3af;
    }
    
    .w-full {
        width: 100%;
    }
    
    .bg-gray-200 {
        background-color: #e5e7eb;
    }
    
    .rounded-full {
        border-radius: 9999px;
    }
    
    .h-2\.5 {
        height: 0.625rem;
    }
    
    .dark\:bg-gray-700 {
        background-color: #374151;
    }
    
    .bg-indigo-600 {
        background-color: #4f46e5;
    }
    
    .text-center {
        text-align: center;
    }
    
    .py-4 {
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
    
    .text-sm {
        font-size: 0.875rem;
    }
    
    .mr-2 {
        margin-right: 0.5rem;
    }
    
    .mt-2 {
        margin-top: 0.5rem;
    }
    
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
    
    .text-indigo-600 {
        color: #4f46e5;
    }
    
    .dark\:text-indigo-400 {
        color: #818cf8;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .chat-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 200;
            width: 280px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .chat-sidebar.mobile-open {
            transform: translateX(0);
        }
        
        .chat-main {
            width: 100%;
            margin: 0;
            border-radius: 0;
        }
        
        .mobile-sidebar-toggle {
            display: flex;
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            cursor: pointer;
        }
    }
    
    @media (min-width: 769px) {
        .mobile-sidebar-toggle {
            display: none;
        }
    }
    
    .document-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .upload-btn {
        cursor: pointer;
        color: var(--primary-color);
        font-size: 1.25rem;
        padding: 0.25rem;
        border-radius: var(--rounded-sm);
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .upload-btn:hover {
        transform: scale(1.1);
        color: var(--primary-dark);
    }
    
    .upload-progress {
        margin-bottom: 1rem;
    }
    
    .progress-bar-container {
        width: 100%;
        height: 0.5rem;
        background-color: var(--light-hover);
        border-radius: var(--rounded-full);
        overflow: hidden;
    }
    
    body.dark-mode .progress-bar-container {
        background-color: var(--dark-hover);
    }
    
    .progress-bar {
        height: 100%;
        background-color: var(--primary-color);
        border-radius: var(--rounded-full);
        transition: width 0.3s ease;
    }
    
    .upload-status {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
    
    body.dark-mode .upload-status {
        color: #9ca3af;
    }
    
    .empty-document-list {
        text-align: center;
        padding: 2rem 0;
    }
    
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
    }
    
    body.dark-mode .empty-state {
        color: #6b7280;
    }
    
    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }
    
    .empty-state p {
        margin: 0.25rem 0;
    }
    
    .empty-state-hint {
        font-size: 0.75rem;
        margin-top: 0.5rem;
    }
    
    .empty-state-hint i {
        font-size: 0.875rem;
        margin: 0;
        color: var(--primary-color);
        opacity: 1;
    }
    
    .chat-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
    }
    
    .chat-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .clear-chat-btn {
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
        border-radius: var(--rounded-md);
        transition: var(--transition);
    }
    
    body.dark-mode .clear-chat-btn {
        color: #9ca3af;
    }
    
    .clear-chat-btn:hover {
        background-color: var(--light-hover);
        color: #ef4444;
    }
    
    body.dark-mode .clear-chat-btn:hover {
        background-color: var(--dark-hover);
    }
    
    .message-content {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .message-hint {
        font-size: 0.75rem;
        color: #6b7280;
    }
    
    body.dark-mode .message-hint {
        color: #9ca3af;
    }
    
    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar (same as dashboard) -->
    <div class="sidebar">
        <div class="logo-container">
            <h1 class="logo-text">MAJA</h1>
        </div>
        <div class="sidebar-header">
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-info">
                    <h3>{{ session.user }}</h3>
                    <p>Propriétaire</p>
                </div>
            </div>
        </div>
        <div class="sidebar-content">
            <ul class="sidebar-menu">
                <li>
                    <a href="{{ url_for('dashboard') }}">
                        <i class="fas fa-home"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('new_property') }}">
                        <i class="fas fa-plus-circle"></i>
                        <span>Nouvelle propriété</span>
                    </a>
                </li>
                <li class="active">
                    <a href="{{ url_for('document_chat') }}">
                        <i class="fas fa-comments"></i>
                        <span>Chat Documents</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('logout') }}">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Déconnexion</span>
                    </a>
                </li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <button id="dark-mode-toggle" class="dark-mode-toggle">
                <i class="fas fa-moon"></i>
                <span>Mode sombre</span>
            </button>
            <button id="sidebar-toggle" class="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="chat-container">
            <!-- Chat Sidebar -->
            <div class="chat-sidebar">
                <!-- Model Selector -->
                <div class="model-selector">
                    <label for="model-select">Modèle d'Intelligence Artificielle</label>
                    <select id="model-select">
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="claude-3">Claude 3</option>
                    </select>
                </div>
                
                <!-- Document Section -->
                <div class="document-section">
                    <div class="document-header">
                        <h3>Documents</h3>
                        <label for="file-upload" class="upload-btn">
                            <i class="fas fa-plus-circle"></i>
                            <span class="sr-only">Ajouter un document</span>
                        </label>
                        <input id="file-upload" type="file" class="hidden" accept=".pdf,.doc,.docx,.txt,.rtf,.odt,.xlsx,.xls,.csv" multiple>
                    </div>
                    
                    <div id="upload-progress" class="upload-progress hidden">
                        <div class="progress-bar-container">
                            <div id="upload-progress-bar" class="progress-bar" style="width: 0%"></div>
                        </div>
                        <p id="upload-status" class="upload-status">Téléchargement...</p>
                    </div>
                    
                    <ul id="document-list" class="document-list">
                        {% if documents %}
                            {% for doc in documents %}
                            <li class="document-item" data-id="{{ doc.id }}" data-filename="{{ doc.filename }}">
                                <div class="document-icon">
                                    {% if doc.file_type in ['pdf'] %}
                                    <i class="far fa-file-pdf"></i>
                                    {% elif doc.file_type in ['doc', 'docx', 'odt', 'rtf'] %}
                                    <i class="far fa-file-word"></i>
                                    {% elif doc.file_type in ['xls', 'xlsx', 'csv'] %}
                                    <i class="far fa-file-excel"></i>
                                    {% else %}
                                    <i class="far fa-file-alt"></i>
                                    {% endif %}
                                </div>
                                <div class="document-name">{{ doc.original_name }}</div>
                                <button class="delete-document" data-id="{{ doc.id }}" data-filename="{{ doc.filename }}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </li>
                            {% endfor %}
                        {% else %}
                            <li class="empty-document-list">
                                <div class="empty-state">
                                    <i class="far fa-folder-open"></i>
                                    <p>Aucun document</p>
                                    <p class="empty-state-hint">Cliquez sur <i class="fas fa-plus-circle"></i> pour ajouter</p>
                                </div>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            
            <!-- Chat Main -->
            <div class="chat-main">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-title">
                        <i class="fas fa-comments"></i>
                        <span>Chat avec Documents</span>
                    </div>
                    <div class="chat-actions">
                        <button id="clear-chat" class="clear-chat-btn">
                            <i class="fas fa-trash-alt"></i>
                            <span>Effacer</span>
                        </button>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div id="chat-messages" class="chat-messages">
                    <div class="message message-bot">
                        <div class="message-content">
                            <p>Bonjour! Je suis votre assistant IA pour l'analyse de documents immobiliers. Comment puis-je vous aider aujourd'hui?</p>
                            <p class="message-hint">Sélectionnez des documents dans la barre latérale pour me permettre de les analyser.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input">
                    <form id="chat-form">
                        <input type="text" id="message-input" placeholder="Posez une question sur vos documents..." autocomplete="off">
                        <button type="submit" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Sidebar Toggle Button -->
<div class="mobile-sidebar-toggle">
    <i class="fas fa-bars"></i>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const documentList = document.getElementById('document-list');
        const fileUpload = document.getElementById('file-upload');
        const uploadProgress = document.getElementById('upload-progress');
        const uploadProgressBar = document.getElementById('upload-progress-bar');
        const uploadStatus = document.getElementById('upload-status');
        const clearChatBtn = document.getElementById('clear-chat');
        const modelSelect = document.getElementById('model-select');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mobileSidebarToggle = document.querySelector('.mobile-sidebar-toggle');
        const chatSidebar = document.querySelector('.chat-sidebar');
        
        // State
        let selectedDocuments = [];
        let chatHistory = [];
        let isWaitingForResponse = false;
        
        // Check for dark mode preference
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
        }
        
        // Dark mode toggle
        darkModeToggle.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
        });
        
        // Sidebar toggle
        sidebarToggle.addEventListener('click', function() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
            document.querySelector('.main-content').classList.toggle('expanded');
        });
        
        // Mobile sidebar toggle
        mobileSidebarToggle.addEventListener('click', function() {
            chatSidebar.classList.toggle('mobile-open');
        });
        
        // Load documents on page load
        fetchDocuments();
        
        // File upload handler
        fileUpload.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadFiles(e.target.files);
            }
        });
        
        // Chat form submission
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message && !isWaitingForResponse) {
                sendMessage(message);
                messageInput.value = '';
            }
        });
        
        // Clear chat
        clearChatBtn.addEventListener('click', function() {
            chatMessages.innerHTML = `
                <div class="message message-bot">
                    <p>Bonjour! Je suis votre assistant IA pour l'analyse de documents immobiliers. Comment puis-je vous aider aujourd'hui?</p>
                    <p class="text-sm text-gray-500 mt-2">Sélectionnez des documents dans la barre latérale pour me permettre de les analyser.</p>
                </div>
            `;
            chatHistory = [];
        });
        
        // Document selection
        documentList.addEventListener('click', function(e) {
            const documentItem = e.target.closest('.document-item');
            const deleteBtn = e.target.closest('.delete-document');
            
            if (deleteBtn) {
                e.stopPropagation();
                const docId = deleteBtn.dataset.id;
                const filename = deleteBtn.dataset.filename;
                deleteDocument(docId, filename);
            } else if (documentItem) {
                const docId = documentItem.dataset.id;
                documentItem.classList.toggle('selected');
                
                if (documentItem.classList.contains('selected')) {
                    if (!selectedDocuments.includes(docId)) {
                        selectedDocuments.push(docId);
                    }
                } else {
                    selectedDocuments = selectedDocuments.filter(id => id !== docId);
                }
            }
        });
        
        // Functions
        function fetchDocuments() {
            fetch('/api/documents')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderDocumentList(data.documents);
                    } else {
                        console.error('Failed to fetch documents:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching documents:', error);
                });
        }
        
        function renderDocumentList(documents) {
            if (documents.length === 0) {
                documentList.innerHTML = `
                    <li class="text-center text-gray-500 dark:text-gray-400 py-4">
                        <p>Aucun document</p>
                        <p class="text-sm">Cliquez sur + pour ajouter</p>
                    </li>
                `;
                return;
            }
            
            documentList.innerHTML = documents.map(doc => `
                <li class="document-item" data-id="${doc.id}" data-filename="${doc.filename}">
                    <div class="document-icon">
                        ${getDocumentIcon(doc.file_type)}
                    </div>
                    <div class="document-name">{{ doc.original_name }}</div>
                    <button class="delete-document text-gray-400 hover:text-red-500" data-id="${doc.id}" data-filename="${doc.filename}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </li>
            `).join('');
        }
        
        function getDocumentIcon(fileType) {
            const fileTypes = {
                pdf: '<i class="far fa-file-pdf"></i>',
                doc: '<i class="far fa-file-word"></i>',
                docx: '<i class="far fa-file-word"></i>',
                odt: '<i class="far fa-file-word"></i>',
                rtf: '<i class="far fa-file-word"></i>',
                xls: '<i class="far fa-file-excel"></i>',
                xlsx: '<i class="far fa-file-excel"></i>',
                csv: '<i class="far fa-file-excel"></i>'
            };
            
            return fileTypes[fileType] || '<i class="far fa-file-alt"></i>';
        }
        
        function uploadFiles(files) {
            const formData = new FormData();
            
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            
            // Show progress bar
            uploadProgress.classList.remove('hidden');
            uploadProgressBar.style.width = '0%';
            uploadStatus.textContent = 'Téléchargement...';
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    uploadProgressBar.style.width = percentComplete + '%';
                    uploadStatus.textContent = `Téléchargement: ${percentComplete}%`;
                }
            });
            
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        uploadStatus.textContent = 'Téléchargement terminé!';
                        setTimeout(() => {
                            uploadProgress.classList.add('hidden');
                            fetchDocuments();
                        }, 1500);
                    } else {
                        uploadStatus.textContent = 'Erreur: ' + response.message;
                        setTimeout(() => {
                            uploadProgress.classList.add('hidden');
                        }, 3000);
                    }
                } else {
                    uploadStatus.textContent = 'Erreur de téléchargement';
                    setTimeout(() => {
                        uploadProgress.classList.add('hidden');
                    }, 3000);
                }
            });
            
            xhr.addEventListener('error', function() {
                uploadStatus.textContent = 'Erreur de connexion';
                setTimeout(() => {
                    uploadProgress.classList.add('hidden');
                }, 3000);
            });
            
            xhr.open('POST', '/api/upload-documents', true);
            xhr.send(formData);
        }
        
        function deleteDocument(docId, filename) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer ce document: ${filename}?`)) {
                fetch(`/api/documents/${docId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        fetchDocuments();
                        selectedDocuments = selectedDocuments.filter(id => id !== docId);
                    } else {
                        console.error('Failed to delete document:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error deleting document:', error);
                });
            }
        }
        
        function sendMessage(message) {
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Set waiting flag
            isWaitingForResponse = true;
            
            // Prepare request data
            const requestData = {
                message: message,
                document_ids: selectedDocuments,
                model: modelSelect.value,
                history: chatHistory
            };
            
            // Send request to server
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                // Remove typing indicator
                chatMessages.removeChild(typingIndicator);
                
                if (data.success) {
                    // Add bot message to chat
                    addMessageToChat('bot', data.response);
                    
                    // Update chat history
                    chatHistory.push({
                        role: 'user',
                        content: message
                    });
                    chatHistory.push({
                        role: 'assistant',
                        content: data.response
                    });
                } else {
                    // Add error message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'message message-bot error';
                    errorDiv.textContent = 'Erreur: ' + (data.message || 'Impossible de traiter votre demande');
                    chatMessages.appendChild(errorDiv);
                }
                
                // Reset waiting flag
                isWaitingForResponse = false;
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(error => {
                // Remove typing indicator
                chatMessages.removeChild(typingIndicator);
                
                // Add error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message message-bot error';
                errorDiv.textContent = 'Erreur de connexion. Veuillez réessayer.';
                chatMessages.appendChild(errorDiv);
                
                // Reset waiting flag
                isWaitingForResponse = false;
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                console.error('Error sending message:', error);
            });
        }
        
        function addMessageToChat(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            
            // Process markdown-like formatting
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = formattedContent;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
</script>
{% endblock %}
